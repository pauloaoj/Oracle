CREATE OR REPLACE FUNCTION SANKHYA.FC_QTDALT_HL (P_CODPRO IN NUMBER, P_QTD IN FLOAT, P_CODVOL VARCHAR2)
RETURN FLOAT
IS
   P_CODVOLPRO  VARCHAR2(2);
   P_DECQTD     NUMBER;
   QTD          FLOAT;
   P_DIVIDEMULTIPLICA VARCHAR2(1);
   P_QUANTIDADE FLOAT;
   P_MULTIPVLR FLOAT;
   
   PRAGMA AUTONOMOUS_TRANSACTION;
BEGIN
  QTD := P_QTD;

  SELECT CODVOL, DECQTD
  INTO P_CODVOLPRO, P_DECQTD
  FROM TGFPRO
  WHERE CODPROD = P_CODPRO;

  IF P_CODVOL <> P_CODVOLPRO THEN
    SELECT DIVIDEMULTIPLICA, QUANTIDADE, MULTIPVLR
    INTO P_DIVIDEMULTIPLICA, P_QUANTIDADE ,P_MULTIPVLR
    FROM TGFVOA
    WHERE CODVOL = P_CODVOL AND CODPROD = P_CODPRO;

    IF P_DIVIDEMULTIPLICA = 'D' THEN
      QTD := ROUND(QTD * (P_QUANTIDADE * P_MULTIPVLR), 4); --P_DECQTD);
    ELSE
      QTD := ROUND(QTD / (P_QUANTIDADE * P_MULTIPVLR), 4);--P_DECQTD);
    END IF;
  END IF;
  RETURN( QTD );
EXCEPTION
   WHEN NO_DATA_FOUND THEN RETURN (QTD);
END;
/